#! /usr/bin/env bash

set -euo pipefail

log() {
  printf '%s\n' "$@"
} >&2

usage() {
  cat <<DOG
usage: $0 [port]
start a clojure socket-repl on port (5555)
DOG
}

die() {
  local ex="${1:-1}"
  exit "$ex"
}

usage_and_die() { usage && die; }

main() {
  local port
  case $# in
    0) port=5555;;
    1)
      case "$1" in
        -h|--help) usage_and_die;;
        *) port="$1";;
      esac
      ;;
    *) usage_and_die;;
  esac
  cmd=(
    java
    -classpath "$(clj -Spath)"
    "-Dclojure.server.repl={:port $port :accept clojure.core.server/repl}"
    clojure.main
  )
  log "starting server on $port"
  "${cmd[@]}"
}

main "$@"
